WITH tardies AS (SELECT id, date, dm_id, morning, break, lunch, afternoon FROM attendance WHERE (date > CURRENT_DATE - interval '2 weeks') AND (morning > 0 OR break > 0 OR lunch > 0 OR afternoon > 0)), totals AS (SELECT (CASE WHEN morning > 0 THEN 1 ELSE 0 END + CASE WHEN lunch > 0 THEN 1 ELSE 0 END + CASE WHEN break > 0 THEN 1 ELSE 0 END + CASE WHEN afternoon > 0 THEN 1 ELSE 0 END) AS count, (COALESCE(morning, 0) + COALESCE(break,0) + COALESCE(lunch,0) + COALESCE(afternoon, 0)) AS total, dm_id FROM tardies GROUP BY dm_id, total, count), outliers AS (SELECT SUM(count) AS count, SUM(total) AS total, dm_id FROM totals GROUP BY dm_id HAVING SUM(count) > 2)

SELECT s.first_name, s.last_name, s.dm_id, tardies.date, tardies.id, tardies.morning, tardies.break, tardies.lunch, tardies.afternoon, outliers.count, outliers.total FROM tardies JOIN students s ON s.dm_id = tardies.dm_id JOIN outliers ON s.dm_id = outliers.dm_id AND cohort_id IN (${cohorts:csv});	